from androguard.core.bytecodes.dvm import DalvikVMFormat
from androguard.core.analysis.analysis import VMAnalysis
from androguard.decompiler.decompiler import DecompilerDAD
from androguard.core.bytecodes.apk import APK
from androguard.core.analysis import analysis
from androguard.core.bytecodes import dvm
import math
import hashlib
import glob, os

#To extract permission of APK file from Androguard
def extract_features(file_path):
    #result = []
    try:
        a = APK(file_path)
        d = DalvikVMFormat(a.get_dex())
        dx = VMAnalysis(d)
        vm = dvm.DalvikVMFormat(a.get_dex())
        vmx = analysis.uVMAnalysis(vm)
        d.set_vmanalysis(dx)
        d.set_decompiler(DecompilerDAD(d, dx))
    except:
        return None
    return a.get_permissions()    #it will return permission

#Tt will extract unique permission and it will save in permission_list_unique list
def get_unique_permission():
    os.chdir("C:\\Users\\SHAHZAD\\Desktop\\Complete_Ans\Beningn")
    max_case = 430
    i = 1
    permission_list_unique = []
    for file in glob.glob("*"):
        if i<=max_case:
            permissions = extract_features(file)
            if permissions is None:
                pass
            else:
                for permission in permissions:
                    if permission not in permission_list_unique:
                        permission_list_unique.append(permission)
            print "Progress: ",str((float(i)/float(max_case))*100.00),"%"
        i+=1
    return permission_list_unique


#It take one feature from unique list and find the frequecy of that feature i.e in ow many file that feature is present
if __name__ == "__main__":
    os.chdir("C:\\Users\\SHAHZAD\\Desktop\\Complete_Ans\Beningn")
    max_case = 430 #total number of file dataset
    i = 1
    permission_list = []
    for file in glob.glob("*"):
        if i<=max_case:
            permissions = extract_features(file)
            if permissions is None:
                pass
            else:
                for permission in permissions:
                    #if permission not in permission_list:
                        permission_list.append(permission)
            print "Progress: ",str((float(i)/float(max_case))*100.00),"%"
        i+=1

    unique_list=get_unique_permission()  #Getting unique list
    with open('beningn_frequency.txt','w+') as op:    #writing intp file 
     for u_perm in unique_list:
      count=0  
      for permission in permission_list:
        if(u_perm==permission):
           count=count+1
        #print count 
      op.write(str(u_perm))
      print(str(u_perm))
      op.write('\t')
      op.write(str(count))
      print(str(count))
      op.write('\n')
