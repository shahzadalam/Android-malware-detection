# -*- coding: utf-8 -*-
"""
Created on Tue Apr 7  10:09:02 2017

@author: SHAHZAD
"""
import csv
import os
import glob
from androguard.core.bytecodes.dvm import DalvikVMFormat
from androguard.core.analysis.analysis import VMAnalysis
from androguard.decompiler.decompiler import DecompilerDAD
from androguard.core.bytecodes.apk import APK
from androguard.core.analysis import analysis
from androguard.core.bytecodes import dvm

#To extract permission of APK file from Androguard
def extract_features(file_path):
    #result = []
    try:
        a = APK(file_path)
        d = DalvikVMFormat(a.get_dex())
        dx = VMAnalysis(d)
        vm = dvm.DalvikVMFormat(a.get_dex())
        vmx = analysis.uVMAnalysis(vm)
        d.set_vmanalysis(dx)
        d.set_decompiler(DecompilerDAD(d, dx))
    except:
        return None

    return a.get_permissions()  #return permission

text_file = open("beningn_top100.txt", "r")   #Getting the top 100 beningn feature
b_feature1 = text_file.readlines()
text_file.close()
text_file = open("malware_top100.txt", "r")  #Getting the top 100 beningn feature
m_feature1 = text_file.readlines()
text_file.close()
feature_list=[]
for perm in b_feature1:
   perm2=perm.split('\n')
   feature_list.append(perm2[0])

for perm1 in m_feature1:
   perm3=perm1.split('\n')
   feature_list.append(perm3[0])
   
feature=set(feature_list)       #Removing the redundant feature
feature_list=[]
print(len(feature))
   
with open("complete_train_file.csv", "w") as csvfile: 
  csvfile.write('class')                       #wring the header for class label
  csvfile.write(',')
  for feat in feature:
     feature_list.append(feat)
     csvfile.write(feat)
     csvfile.write(',')

  #Extracing the feature from Malware dataset 
  os.chdir("C:\\Users\\SHAHZAD\\Desktop\\shahzad\\ANS project\\Malware") #Folder path of Malware apk
  max_case = 430                                                     #Total number of apk in a folder
  i = 0
  permission_list = []
  
  for file in glob.glob("*"):
        if i<max_case:
            permissions = extract_features(file)
            if permissions is None:
                pass
            else:
                
                for permission in permissions:
                    permission_list.append(permission)
            print "Progress: ",str((float(i)/float(max_case))*100.00),"%"    #it will show how much file it process
            i+=1
            csvfile.write('\n')
            csvfile.write('malware')                         #writing class label
            csvfile.write(',')
            print len(permission_list)
            for feat in feature :
             j=0
             for perm in permission_list:
                 if(feat==perm):
                     j=j+1
             if(j>0):
                    
                    csvfile.write('1')
                    csvfile.write(',')
             else:
                     
                     csvfile.write('0')
                     csvfile.write(',')

 #Extracting permission from apk in a beningn folder 
  os.chdir("C:\\Users\\SHAHZAD\\Desktop\\shahzad\\ANS project\\Beningn") #Folder path of Beningn apk
  max_case = 430                                                     #Total number of apk in a folder
  i = 0
  permission_list = []
  
  for file in glob.glob("*"):
        if i<max_case:
            permissions = extract_features(file)
            if permissions is None:
                pass
            else:
                
                for permission in permissions:
                    permission_list.append(permission)
            print ("Progress: ",str((float(i)/float(max_case))*100.00),"%")     #it will show how much file it process
            i+=1
            csvfile.write('\n')
            csvfile.write('beningn')                       #writing class label
            csvfile.write(',')
            print len(permission_list)
            for feat in feature :
             j=0;
             for perm in permission_list:
                 if(feat==perm):
                     j=j+1
             if(j>0):
                    csvfile.write('1')
                    csvfile.write(',')
             else:
                     csvfile.write('0')
                     csvfile.write(',')
    